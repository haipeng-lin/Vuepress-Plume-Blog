---
title: 架构
createTime: 2025/01/15 20:48:56
permalink: /Database/MySQL/k400bztg/
---

## 1.MySQL 分层

MySQL 从上到下可分为系统服务层、存储引擎层、以及文件系统层

1. **服务层**：连接器、解析器、预处理器、优化器、以及执行器
2. **引擎层**：InnoDB、MyISAM
3. **系统层**：涵盖所有日志、数据、以及索引文件

![img](https://img.haipeng-lin.cn/20251003074127.png)

## 2.查询语句的执行流程

1. 连接管理：客户端连接管理
2. **查询缓存：** 在 MySQL8.0 之前，检查是否有缓存数据
3. **解析：** 解析器对 SQL 语句进行词法和语法分析，将 SQL 语句分解成词元，构建解析树
4. **预处理：** 预处理器检查表和字段是否存在，验证用户权限
5. **优化：** 优化器选择合适索引、优化多表连接顺序，生成最优执行计划
6. **执行：** 根据执行计划，调用存储引擎接口，存储引擎负责数据读取和返回
7. **返回结果：** 返回给客户端

## 3.更新语句的执行流程

更新语句的执行流程分为两个过程：

1. 第一阶段（准备阶段）
   1. 查询缓存池是否存在待更新的数据，不存在则将需要更新的数据页从磁盘加载到缓冲池
   2. 将旧数据记录到 undo log 中，用于事务回滚
   3. 在缓存池中更新数据
   4. 将修改记录写入 redo log，**并写入 prepare 标志**，此时准备事务完成
   5. 将更新 sql 语句写入 bin log，把 bing log 写入磁盘
2. 第二阶段（提交阶段）
   1. **在 redo log 中写入 commit 标记**
   2. 返回客户端更新成功消息

> 补充：为什么写入 redo log 要分成两个阶段，prepare 和 commit？

1. 第一阶段中，写入 redo log 和 bin log 两个日志的过程，如果写了 redo log 日志后，出现数据库宕机，会出现 redo 和 binlog 日志不一致的情况
2. 即使写入 redo log 和 bin log 后，也不能保证 redo 和 binlog 日志是一样的。这就会导致了数据不一致的问题。而 commit 就是保证连个日志数据一致，事务才算提交成功。

## 4.MySQL 的一行数据存储

待写
