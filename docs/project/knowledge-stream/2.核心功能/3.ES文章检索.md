---
title: ESæ–‡ç« æ£€ç´¢
permalink: /project/knowledge-stream/5soa8cnd/
createTime: 2025/01/19 13:14:59
---





 ## 1.å‰è¨€

åœ¨æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ElasticSearchå®ç°æ–‡ç« æ£€ç´¢ï¼Œä½¿ç”¨Canalå®ç°ESå’ŒMySQLæ•°æ®åŒæ­¥ï¼Œå…¶ä¸­å…·ä½“å®ç°äº†å…¨é‡æ•°æ®åŒæ­¥å’Œå¢é‡æ•°æ®åŒæ­¥ï¼›åŒæ—¶å°†æ•´åˆESå®¢æˆ·ç«¯å®ç°æ•°æ®æ£€ç´¢

## 2.ç¯å¢ƒå‡†å¤‡

æˆ‘ä»¬éœ€è¦å®‰è£…ElasticSearchï¼ˆv7.17.4ï¼‰ã€Kinabaï¼ˆv7.17.4ï¼‰ã€IKåˆ†è¯å™¨ï¼ˆv7.17.4ï¼‰ã€Canalï¼ˆv1.1.7ï¼‰

ä¸€å®šä¸€å®šè¦ä¿æŒä¸‹è½½ç‰ˆæœ¬å’Œä¸Šè¿°çš„ä¸€è‡´ï¼Œä¸ç„¶ä¼šå‡ºç°å„ç§ç‰ˆæœ¬ä¸å…¼å®¹é—®é¢˜ï¼Œå¯åŠ¨å¤±è´¥

### 2.1 ElasticSearch

> dockerå®‰è£…ESå‘½ä»¤ï¼š

```yml
# æ‹‰å–ESé•œåƒ
docker pull elasticsearch:7.17.4
```

```yml
# å¯åŠ¨ESå®¹å™¨ æ³¨æ„/mydata/elasticsearch/pluginsï¼Œåé¢ä¼šç”¨åˆ°
docker run --name my-es -p 9200:9200 -p 9300:9300 \
-e "discovery.type=single-node" \-e ES_JAVA_OPTS="-Xms64m -Xmx512m" \
-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \
-v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \
-d elasticsearch:7.17.4
```

- æµ‹è¯•æ˜¯å¦åˆ›å»ºæˆåŠŸï¼šipåœ°å€:9200

<img src="https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112108.png" alt="image-20241103172936394" style="zoom:67%;" />

### 2.2 Kibana

> dockerå®‰è£…kibanaå‘½ä»¤ï¼š

```yml
docker pull kibana:7.17.4
```

```yml
# æ³¨æ„ï¼Œè‹¥ESå®‰è£…åœ¨æœ¬åœ°ï¼Œåˆ™ESçš„åœ°å€è¦å¡«è™šæ‹Ÿåœ°å€ï¼ˆipconfigå‘½ä»¤ï¼‰
docker run --name kibana -e ELASTICSEARCH_HOSTS=http://192.168.234.128:9200 -p 5601:5601 \
-d kibana:7.17.4
```

- æµ‹è¯•æ˜¯å¦è®¿é—®æˆåŠŸï¼šhttp://127.0.0.1:5601/
- æ“ä½œESåœ°å€ï¼šhttp://localhost:5601/app/dev_tools#/console

### 2.3 IKåˆ†è¯å™¨

- ä¸‹è½½åœ°å€ï¼šhttps://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.17.4

![image-20241103173610918](https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629113435.png)

- å°†ä¸‹è½½çš„å‹ç¼©åŒ…è§£å‹ç¼©åœ¨ESçš„pluginsæ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶é‡å‘½åä¸ºikã€‚è™šæ‹Ÿæœºå³/mydata/elasticsearch/pluginsä½ç½®ï¼Œwindowsè§è‡ªå·±è®¾ç½®çš„æ˜ å°„ä½ç½®ï¼š

![image-20241103173940475](https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112102.png)

- é‡å¯ESï¼Œæµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ

<img src="https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112058.png" alt="image-20241103174052107" style="zoom:67%;" />

### 2.4 Canal

#### 2.4.1 ä¸‹è½½åœ°å€

- ä¸‹è½½åœ°å€ï¼šhttps://github.com/alibaba/canal/releases/tag/canal-1.1.7
- æ³¨æ„ï¼šå¿…é¡»ä¸‹è½½v1.1.7æ­£å¼ç‰ˆæœ¬ï¼Œéƒ½æ˜¯æœ¬äººäº²è‡ªè¸©çš„å‘ğŸ˜­ğŸ˜­ğŸ˜­
	- 1.1.6æ­£å¼ç‰ˆæœ¬å…¼å®¹ä¸äº† JDK1.8ç‰ˆæœ¬ï¼Œéœ€è¦å‡çº§ JDKç‰ˆæœ¬
	- 1.1.7çš„alphaç‰ˆæœ¬ä¼šå‡ºç° é…ç½®ä¸èƒ½ä»¥"_"å¼€å¤´å¯¼è‡´çš„esMapingååºåˆ—åŒ–å¤±è´¥ çš„bug
- canal.deployerï¼šcanalçš„æœåŠ¡ç«¯ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯æ¥æ”¶æ•°æ®åº“å˜æ›´ä¿¡æ¯
- canal.adapterï¼šå¢åŠ å®¢æˆ·ç«¯æ•°æ®è½åœ°çš„é€‚é…ï¼Œå³å½“æœåŠ¡ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šæ ¹æ®ä¸åŒçš„ç›®æ ‡æºåšé€‚é…ï¼Œæ¯”å¦‚ESç›®æ ‡æºå’Œhbaseé€‚é…

![image-20241103175430859](https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112052.png)

#### 2.4.2 canal.deployeré…ç½®

- ä¿®æ”¹ï¼šconfæ–‡ä»¶å¤¹çš„**canal.properties**ï¼ŒæœåŠ¡ç«¯æ³¨å†Œçš„åœ°å€ã€ç«¯å£ï¼›ç”¨äºadapterå‘ç°

```yml
# register ip to zookeeper
canal.register.ip = 127.0.0.1
canal.port = 11111
```

- ä¿®æ”¹ï¼šconfâ€”â€”>exampleæ–‡ä»¶å¤¹çš„ **instance.properties** ç›‘å¬çš„æ•°æ®åº“é…ç½®

```yml
# position info
canal.instance.master.address=127.0.0.1:3306
```

- å¯åŠ¨ï¼šbinæ–‡ä»¶å¤¹çš„startup.batå‘½ä»¤
- æŸ¥çœ‹æ—¥å¿—ï¼š

![image-20241103180424841](https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112044.png)

#### 2.4.3 canal.adapteré…ç½®

- é¦–å…ˆï¼ŒæŠŠadapter çš„config ä¸‹é¢çš„ bootstrap.yml å†…å®¹å…¨éƒ¨æ³¨é‡Šæ‰ï¼Œå¦åˆ™ä¼šæç¤º XX è¡¨ä¸å­˜åœ¨

![image-20241103180633645](https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112038.png)

- ä¿®æ”¹ï¼šadapter çš„config çš„ application.yml é…ç½®æ–‡ä»¶ï¼Œè¿æ¥canalçš„æœåŠ¡ç«¯ã€å…¨é‡æ•°æ®åŒæ­¥è®¾ç½®ã€ESé…ç½®

![image-20241103181039302](https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112036.png)

- æ–°å¢ï¼šåœ¨adapterâ€”â€”>configâ€”â€”>esæ–‡ä»¶å¤¹æ–°å¢æ–‡ä»¶ article.ymlï¼Œå¯¹articleè¡¨è¿›è¡Œç›‘å¬

```yml
dataSourceKey: defaultDS
destination: example
groupId: g1
esMapping:
  _index: article
  _id: _id
#  upsert: true
#  pk: id
  sql: "SELECT t.id As _id, t.id, t.user_id, t.article_type,t.title,t.short_title,t.picture,t.summary,t.category_id,t.source,t.source_url,t.offical_stat,t.topping_stat,
        t.cream_stat,t.status,t.deleted,t.create_time,t.update_time
        FROM article t"
#sq1æ˜ å°„
  commitBatch: 1
```

- å¯åŠ¨ï¼šbinç›®å½•ä¸‹çš„startup.batå‘½ä»¤ï¼Œå¯åŠ¨8081ç«¯å£

### 2.5 ESæ–°å¢ç´¢å¼•

```yml
PUT /article
{
  "mappings": {
    "properties": {
      "id": {
        "type": "integer"
      },
      "user_id": {
        "type": "integer"
      },
      "article_type": {
        "type": "integer"
      },
      "title": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "short_title": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "picture": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "summary": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "category_id": {
        "type": "integer"
      },
      "source": {
        "type": "integer"
      },
      "source_url": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "offical_stat": {
        "type": "integer"
      },
      "topping_stat": {
        "type": "integer"
      },
      "cream_stat": {
        "type": "integer"
      },
      "status": {
        "type": "integer"
      },
      "deleted": {
        "type": "integer"
      },
      "create_time": {
        "type": "date"
      },
      "update_time": {
        "type": "date"
      }
    }
  }
}
```

### 2.6 æ•°æ®åŒæ­¥

#### 2.6.1 å…¨é‡åŒæ­¥

- ä½¿ç”¨adapteræœåŠ¡æä¾›çš„æ¥å£å®ç°å…¨é‡æ•°æ®åŒæ­¥

![image-20241103145435839](https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112028.png)

- æŸ¥è¯¢æ•°æ®ï¼š

![image-20241103181858140](https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112026.png)

#### 2.6.2 å¢é‡åŒæ­¥

- æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤æ–‡ç« éƒ½ä¼šåŒæ—¶ä¿®æ”¹ESçš„æ•°æ®

<img src="https://gcore.jsdelivr.net/gh/haipeng-lin/blog-img/20250629112023.png" alt="image-20241103185342591" style="zoom: 67%;" />

## 3.ESå®¢æˆ·ç«¯æ£€ç´¢æ•°æ®

### 3.1 å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.elasticsearch</groupId>
    <artifactId>elasticsearch</artifactId>
    <version>6.8.2</version>
</dependency>

<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-client</artifactId>
    <version>6.8.2</version>
</dependency>
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-high-level-client</artifactId>
    <version>6.8.2</version>
</dependency>
```

### 3.2 é…ç½®yml

```yml
# elasticsearché…ç½®
elasticsearch:
  # æ˜¯å¦å¼€å¯ESï¼Ÿæœ¬åœ°å¯åŠ¨å¦‚æœæ²¡æœ‰å®‰è£…ESï¼Œå¯ä»¥è®¾ç½®ä¸ºfalseå…³é—­ES
  open: false
  # esé›†ç¾¤åç§°
  clusterName: elasticsearch
  hosts: 127.0.0.1:9200
  userName: elastic
  password: elastic
  # es è¯·æ±‚æ–¹å¼
  scheme: http
  # es è¿æ¥è¶…æ—¶æ—¶é—´
  connectTimeOut: 1000
  # es socket è¿æ¥è¶…æ—¶æ—¶é—´
  socketTimeOut: 30000
  # es è¯·æ±‚è¶…æ—¶æ—¶é—´
  connectionRequestTimeOut: 500
  # es æœ€å¤§è¿æ¥æ•°
  maxConnectNum: 100
  # es æ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•°
  maxConnectNumPerRoute: 100
```

### 3.3 ESé…ç½®ç±»

```java
@Slf4j
@Data
@Configuration
// ä¸‹é¢è¿™ä¸ªè¡¨ç¤ºåªæœ‰ elasticsearch.open = true æ—¶ï¼Œé‡‡è¿›è¡Œesçš„é…ç½®åˆå§‹åŒ–ï¼›å½“ä¸ä½¿ç”¨esæ—¶ï¼Œåˆ™ä¸ä¼šå®ä¾‹ RestHighLevelClient
@ConditionalOnProperty(prefix = "elasticsearch", name = "open")
@ConfigurationProperties(prefix = "elasticsearch")
public class ElasticsearchConfig {

    // æ˜¯å¦å¼€å¯ES
    private Boolean open;

    // es host ip åœ°å€ï¼ˆé›†ç¾¤ï¼‰
    private String hosts;

    // esç”¨æˆ·å
    private String userName;

    // eså¯†ç 
    private String password;

    // es è¯·æ±‚æ–¹å¼
    private String scheme;

    // esé›†ç¾¤åç§°
    private String clusterName;

    // es è¿æ¥è¶…æ—¶æ—¶é—´
    private int connectTimeOut;

    // es socket è¿æ¥è¶…æ—¶æ—¶é—´
    private int socketTimeOut;

    // es è¯·æ±‚è¶…æ—¶æ—¶é—´
    private int connectionRequestTimeOut;

    // es æœ€å¤§è¿æ¥æ•°
    private int maxConnectNum;

    // es æ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•°
    private int maxConnectNumPerRoute;


    /**
     * å¦‚æœ@Beanæ²¡æœ‰æŒ‡å®šbeançš„åç§°ï¼Œé‚£ä¹ˆè¿™ä¸ªbeançš„åç§°å°±æ˜¯æ–¹æ³•å
     */
    @Bean(name = "restHighLevelClient")
    public RestHighLevelClient restHighLevelClient() {

        // æ­¤å¤„ä¸ºå•èŠ‚ç‚¹es
        String host = hosts.split(":")[0];
        String port = hosts.split(":")[1];
        HttpHost httpHost = new HttpHost(host, Integer.parseInt(port));

        // æ„å»ºè¿æ¥å¯¹è±¡
        RestClientBuilder builder = RestClient.builder(httpHost);

        // è®¾ç½®ç”¨æˆ·åã€å¯†ç 
        CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
        credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(userName, password));

        // è¿æ¥å»¶æ—¶é…ç½®
        builder.setRequestConfigCallback(requestConfigBuilder -> {
            requestConfigBuilder.setConnectTimeout(connectTimeOut);
            requestConfigBuilder.setSocketTimeout(socketTimeOut);
            requestConfigBuilder.setConnectionRequestTimeout(connectionRequestTimeOut);
            return requestConfigBuilder;
        });
        // è¿æ¥æ•°é…ç½®
        builder.setHttpClientConfigCallback(httpClientBuilder -> {
            httpClientBuilder.setMaxConnTotal(maxConnectNum);
            httpClientBuilder.setMaxConnPerRoute(maxConnectNumPerRoute);
            httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
            return httpClientBuilder;
        });

        return new RestHighLevelClient(builder);
    }
}
```

### 3.4 ESæ£€ç´¢æ•°æ®

```java
@Override
public List<SimpleArticleDTO> querySimpleArticleBySearchKey(String key) {
    // å½“keyä¸ºç©ºæ—¶ï¼Œè¿”å›çƒ­é—¨æ¨è
    if (StringUtils.isBlank(key)) {
        return Collections.emptyList();
    }
    key = key();
    if (!openES) {
        // 1ã€æ•°æ®åº“æ£€ç´¢
        List<ArticleDO> records = articleDao.listSimpleArticlesByBySearchKey(key);
        return records.stream().map(s -> new SimpleArticleDTO().setId(s.getId()).setTitle(s.getTitle()))
            .collect(Collectors.toList());
    }
    // 2ã€ESæ£€ç´¢
    // 2.1ã€SearchSourceBuilderï¼šæ„å»ºæœç´¢è¯·æ±‚
    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    // 2.2ã€MultiMatchQueryBuilderï¼šæ„å»ºå¤šå­—æ®µåŒ¹é…æŸ¥è¯¢
    MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(key,
                                                                                  EsFieldConstant.ES_FIELD_TITLE,
                                                                                  EsFieldConstant.ES_FIELD_SHORT_TITLE);
    searchSourceBuilder.query(multiMatchQueryBuilder);
    // 2.3ã€æ‰§è¡ŒæŸ¥è¯¢
    SearchRequest searchRequest = new SearchRequest(new String[]{EsIndexConstant.ES_INDEX_ARTICLE}, searchSourceBuilder);
    SearchResponse searchResponse = null;
    try {
        searchResponse = SpringUtil.getBean(RestHighLevelClient.class).search(searchRequest, RequestOptions.DEFAULT);
    } catch (IOException e) {
        log.error("failed to query from es: key", e);
    }
    // 2.4ã€è·å–æŸ¥è¯¢ç»“æœçš„å‘½ä¸­ï¼ˆSearchHitsï¼‰ï¼Œå¹¶æå–æ‰€æœ‰å‘½ä¸­çš„æ–‡ç« ï¼ˆSearchHitæ•°ç»„ï¼‰ã€‚
    // åˆ›å»ºä¸€ä¸ªidsåˆ—è¡¨ï¼Œæ”¶é›†æ‰€æœ‰åŒ¹é…æ–‡ç« çš„ID
    SearchHits hits = searchResponse.getHits();
    SearchHit[] hitsList = hits.getHits();
    List<Integer> ids = new ArrayList<>();
    for (SearchHit documentFields : hitsList) {
        ids.add(Integer.parseInt(documentFields.getId()));
    }
    if (ObjectUtils.isEmpty(ids)) {
        return null;
    }
    List<ArticleDO> records = articleDao.selectByIds(ids);
    return records.stream().map(s -> new SimpleArticleDTO().setId(s.getId()).setTitle(s.getTitle()))
        .collect(Collectors.toList());
}
``` -->
